#!/usr/bin/env bash
set -euo pipefail

# This pre-commit hook ensures you cannot commit files with Windows-reserved device basenames
# (e.g., nul, con, prn, aux, com1, lpt1) because these are invalid on Windows

reserved_regex='^(nul|con|prn|aux|com[0-9]+|lpt[0-9]+)(\..*)?$'

staged_files=$(git diff --cached --name-only --no-renames)

if [ -z "$staged_files" ]; then
  exit 0
fi

bad_found=0
while IFS= read -r file; do
  [ -z "$file" ] && continue
  base=$(basename "$file")
  base_lower=$(printf "%s" "$base" | tr '[:upper:]' '[:lower:]')
  if [[ "$base_lower" =~ $reserved_regex ]]; then
    echo "ERROR: Avoid committing file with Windows reserved basename: '$file' (basename: $base)"
    bad_found=1
  fi
done <<< "$staged_files"

if [ "$bad_found" -ne 0 ]; then
  echo
  echo "Commit aborted to prevent cross-platform incompatibility."
  echo "Rename the file(s) to a Windows-safe name and try again."
  exit 1
fi

exit 0
