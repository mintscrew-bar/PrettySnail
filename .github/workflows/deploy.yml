name: Deploy to Production

on:
  push:
    branches: [master, main]
  workflow_dispatch:

jobs:
  pre-deploy-checks:
    name: Pre-Deployment Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check environment variables
        run: |
          echo "Checking required environment variables..."
          required_vars=("JWT_SECRET" "ADMIN_USERNAME" "ADMIN_PASSWORD" "DATABASE_URL")
          
          for var in "${required_vars[@]}"; do
            echo "  ✓ $var (will be set in Vercel)"
          done

      - name: Verify build configuration
        run: |
          if [ ! -f "next.config.ts" ]; then
            echo "❌ next.config.ts not found"
            exit 1
          fi
          if [ ! -f "prisma/schema.prisma" ]; then
            echo "❌ prisma/schema.prisma not found"
            exit 1
          fi
          echo "✅ Build configuration verified"

  deploy:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks]
    environment:
      name: production
      url: https://prettysnail.vercel.app
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Vercel
        uses: vercel/action@v6
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          production: true

      - name: Comment on commit
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}';
            const emoji = status === 'success' ? '✅' : '❌';
            github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/tags/deployed-${new Date().toISOString().split('T')[0]}`,
              sha: context.sha
            }).catch(err => console.log('Tag creation skipped:', err.message));
